-- AUTO RYUGA QUEST + AUTO ATTACK 2 ENEMY (MAGNET, TELEPORT)

--====== SERVICES & PLAYER ======--
local Players        = game:GetService("Players")
local RunService     = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace      = game:GetService("Workspace")

local player         = Players.LocalPlayer
local character      = player.Character or player.CharacterAdded:Wait()
local humanoid       = character:WaitForChild("Humanoid")
local hrp            = character:WaitForChild("HumanoidRootPart")

--====== CONFIG ======--

-- Koordinat NPC Ryuga
local RYUGA_POS = Vector3.new(
    3441.72265625,
    7.071476936340332,
    -1803.548095703125
)

local ENEMY1_NAME = "Utsumi Lv.80"
local ENEMY2_NAME = "Mad Isurugi Lv.80"

-- Magnet offset 5 stud di depan enemy
local MAGNET_OFFSET = Vector3.new(0, 0, -5)

--====== UTIL ======--

local function refreshCharacter()
    character = player.Character or player.CharacterAdded:Wait()
    humanoid  = character:WaitForChild("Humanoid")
    hrp       = character:WaitForChild("HumanoidRootPart")
end

--====== TELEPORT KE RYUGA (WARP) ======--

local function teleportToRyuga()
    refreshCharacter()
    hrp.CFrame = CFrame.new(RYUGA_POS)
end

--====== QUEST RYUGA ======--

local function clickRyuga()
    local npcFolder = Workspace:FindFirstChild("NPC")
    if not npcFolder then return end

    local ryuga = npcFolder:FindFirstChild("Ryuga")
    if not ryuga then return end

    local cd = ryuga:FindFirstChildOfClass("ClickDetector")
    if cd then
        fireclickdetector(cd)
    end
end

local function openQuestDialog()
    local args = {
        {
            Choice = "[ Repeatable Quest ]"
        }
    }
    ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Event"):WaitForChild("Dialogue"):FireServer(unpack(args))
end

local function closeDialog()
    local args = {
        {
            Exit = true
        }
    }
    ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Event"):WaitForChild("Dialogue"):FireServer(unpack(args))
end

local function takeQuest()
    clickRyuga()
    task.wait(0.3)
    openQuestDialog()
    task.wait(0.2)
    closeDialog()
end

local function completeQuest()
    clickRyuga()
    task.wait(0.3)
    openQuestDialog()
    task.wait(0.2)
    closeDialog()
end

--====== AUTO ATTACK (5 HIT) ======--

local function fireHeavy()
    local args = {
        {
            CombatAction = true,
            AttackType = "Down",
            HeavyAttack = true,
            MouseData = CFrame.new(-257.47674560546875, 9.776947975158691, -862.2208251953125, 1,0,0, 0,1,0, 0,0,1)
        }
    }
    player.Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent"):FireServer(unpack(args))
end

local function fireBasic()
    local args = {
        {
            CombatAction = true,
            LightAttack = true,
            MouseData = CFrame.new(-257.47674560546875, 9.776947975158691, -862.2208251953125, 1,0,0, 0,1,0, 0,0,1)
        }
    }
    player.Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent"):FireServer(unpack(args))
end

local function fireSkillE()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "E",
            MouseData = CFrame.new(-257.47674560546875, 9.776947975158691, -862.2208251953125, 1,0,0, 0,1,0, 0,0,1)
        }
    }
    player.Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent"):FireServer(unpack(args))
end

local function fireSkillR()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "R",
            MouseData = CFrame.new(-262.78973388671875, 5.367349624633789, -859.2238159179688, 1,0,0, 0,1,0, 0,0,1)
        }
    }
    player.Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent"):FireServer(unpack(args))
end

local function fireSkillV()
    local args = {
        {
            Skill = true,
            AttackType = "Down",
            Key = "V",
            MouseData = CFrame.new(-374.3337707519531, 10.645843505859375, -631.1005859375, 1,0,0, 0,1,0, 0,0,1)
        }
    }
    player.Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent"):FireServer(unpack(args))
end

-- heavy, E, heavy, basic, R, heavy, V
local function comboOnce()
    fireHeavy()
    task.wait(0.25)

    fireSkillE()
    task.wait(0.4)

    fireHeavy()
    task.wait(0.25)

    fireBasic()
    task.wait(0.25)

    fireSkillR()
    task.wait(0.4)

    fireHeavy()
    task.wait(0.25)

    fireSkillV()
    task.wait(0.6)
end

--====== MAGNET KE ENEMY ======--

local magnetConnection

local function startMagnetToEnemy(enemy)
    if magnetConnection then
        magnetConnection:Disconnect()
        magnetConnection = nil
    end

    magnetConnection = RunService.Heartbeat:Connect(function()
        if not enemy or not enemy.Parent or not enemy:FindFirstChild("HumanoidRootPart") then
            return
        end

        local char = player.Character
        if not char then return end

        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end

        local enemyHRP = enemy.HumanoidRootPart
        local targetCFrame = enemyHRP.CFrame * CFrame.new(MAGNET_OFFSET)
        root.CFrame = CFrame.new(targetCFrame.Position, enemyHRP.Position)
    end)
end

local function stopMagnet()
    if magnetConnection then
        magnetConnection:Disconnect()
        magnetConnection = nil
    end
end

local function getEnemyByName(name)
    local lives = Workspace:FindFirstChild("Lives")
    if not lives then return nil end
    return lives:FindFirstChild(name)
end

local function killEnemyByName(name)
    local enemy = getEnemyByName(name)
    if not enemy then return end

    startMagnetToEnemy(enemy)

    while enemy and enemy.Parent == Workspace:FindFirstChild("Lives") do
        comboOnce()
        task.wait(0.05)
        enemy = getEnemyByName(name)
    end

    stopMagnet()
end

--====== MAIN LOOP ======--

task.defer(function()
    while true do
        -- 1) Teleport ke Ryuga
        teleportToRyuga()
        task.wait(0.1)

        -- 2) Ambil quest
        takeQuest()
        task.wait(0.3)

        -- 3) Kill Utsumi Lv.80
        killEnemyByName(ENEMY1_NAME)

        -- 4) Kill Mad Isurugi Lv.80
        killEnemyByName(ENEMY2_NAME)

        -- 5) Balik teleport ke Ryuga, complete quest
        task.wait(0.5)
        teleportToRyuga()
        task.wait(0.2)
        completeQuest()

        -- 6) Loop
        task.wait(0.5)
    end
end)

print("Auto Ryuga Quest + Auto Attack (2 Enemy, Magnet + Combo, Teleport) Loaded.")
